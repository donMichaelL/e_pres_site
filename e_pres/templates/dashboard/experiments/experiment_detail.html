{% extends 'dashboard/base_logged.html' %}
{% load staticfiles %}
{% load crispy_forms_tags %}
{% load poll_extras %}


{% block css_styles %}
<link href="{% static "css/leaflet.css" %}" rel="stylesheet" type="text/css">

<style>
  .extra-margin{
    margin-bottom: 20px;
  }

  .maps-blueprint {
    width: 100%;
    height: 500px;
    border: 1px solid #ccc;
    margin-bottom: 10px;
  }

  .leaflet-div-icon {
  background: transparent;
  border: none;
  }
  .leaflet-marker-icon .number{
  position: relative;
  top: -55px;
  left:-10px;
  font-size: 14px;
  width: 40px;
  text-align: center;
  }
  .leaflet-container img {
  display: block;
  margin-left: auto;
  margin-right: auto
  }
  input[type=number]{
    width: 100px;
  }
</style>
{% endblock %}


{% block title %}{{object.name}} {% endblock %}
{% block main_header %}{{object.name}}
{% if request.GET.next %}
<a type="button"  href="{{request.GET.next}}" class="btn btn-outline btn-default"><i class="fa fa-arrow-left"></i> Back</a>
{% else %}
<a type="button"  href="{% url 'test_list' %}" class="btn btn-outline btn-default"><i class="fa fa-arrow-left"></i> Back</a>
{% endif %}
{% endblock %}


 {% block main_content %}



 <div clas="row">
   <div class="col-xs-12 text-center extra-margin">
       <i class="fa fa-flask fa-5x"></i>
   </div>
   <div class="col-xs-12">
     <form method="POST" action="" class="form-inline">  {% csrf_token %}
       {{form | crispy }}
       <br>
       <br>
       <button type="submit" class="btn btn-success" name="action">Update Experiment</button>
     </form>
   </div>

   <div class="col-xs-12">
     <h1 class="lead">{{object.building}}</h1>
     {% for floor in object.building.floor_set.all %}
     <div class="row">
       <div class="col-md-8">
         <!-- <img src="{{floor.blueprint.url}}" class="img-responsive"/> -->
         <div id="image-map-{{floor.pk}}" class="maps-blueprint"></div>
       </div>
       <div class="col-md-4">
         <h4 class="text-center">{{floor}}</h4>
              <div class="panel panel-default" id="panel-{{floor.pk}}">
                {% for checkpoint in floor.checkpoint_set.all|in_category:object  %}
                <div class="panel-body">
                  <form action="{% url 'checkpoint_new' %}" method="POST" class="form-inline"> {% csrf_token %}
                    <input type="hidden" name="coord_x" value="{{checkpoint.coord_x}}">
                    <input type="hidden" name="coord_y" value="{{checkpoint.coord_y}}">
                    <input type="hidden" name="pk" value={{checkpoint.pk}}>
                    <input type="hidden" name="floor" value="{{floor.pk}}">
                    <input type="hidden" name="experiment" value="{{object.pk}}">
                    <input type="number" width="100px" name="flux" value={{checkpoint.flux}}>
                    <input type="text" name="name" value="{{checkpoint.name}}">
                    <input name="exit" type="checkbox" {% if checkpoint.exit %}checked {% endif %}>
                    <button type="submit" class="btn btn-success" name="action">Update</button>
                    <a href="{% url 'checkpoint_delete' pk=checkpoint.pk %}?next={{object.get_absolute_url}}" type="button" class="btn btn-danger">X</a>
                </form>
              </div>
              {% endfor %}

              </div>
       </div>
    </div>
    {% endfor %}

   </div>


 </div>
 {% endblock %}


{% block js %}
<script src="{% static 'js/leaflet.js' %}"></script>
<script src="{% static 'js/leaf_custom.js' %}"></script>
<script>
{% for floor in object.building.floor_set.all %}
  var map{{floor.pk}} = defineMap('image-map-{{floor.pk}}');
  map{{floor.pk}}.markers = [];
  setMap(map{{floor.pk}}, {{floor.blueprint.width}}, {{floor.blueprint.height}}, '{{floor.blueprint.url}}')
  {% for checkpoint in floor.checkpoint_set.all|in_category:object  %}
    var x = {{checkpoint.coord_x}}, y = {{checkpoint.coord_y}};
    marker = new L.marker([ x, y], {icon: new L.NumberedDivIcon({number: 'ena' }),draggable:'true'});  //.addTo(map{{floor.pk}});
    map{{floor.pk}}.markers.push(marker);
  {% endfor %}
{% endfor %}



var id = 1;
function onMapClick(e) {
  var panel_id = (e.target._container.id).match(/\d+/)[0];
  var marker = new L.marker(e.latlng, {icon: new L.NumberedDivIcon({number: 'id:'+id}),draggable:'true'});
  e.target.markers.push(marker);
  var newRow = jQuery("<div class='panel-body'>  <form action='{% url "checkpoint_new" %}' method='POST'> {% csrf_token %} \
    <input type='hidden' name='coord_x' value='" +e.latlng.lat+ "'> \
    <input type='hidden' name='coord_y' value='" +e.latlng.lng+ "'> \
    <input type='hidden' name='floor' value='"+ panel_id +"'> \
    <input type='hidden' name='experiment' value='"+{{object.pk}} +"'> \
    <input type='number' name='flux' value=''> \
    <input type='text' name='name' value=''> \
    <input name='exit' type='checkbox'> \
    <button type='submit' class='btn btn-default' name=action>Save</button> \
    </form></div> \
  ");


  jQuery('#panel-'+ panel_id).append(newRow);
  marker.on('dragend',function(event){
    var marker = event.target;
    var position = marker.getLatLng();
    marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
    e.target.panTo(new L.LatLng(position.lat, position.lng));
    var marker_id = e.target.markers.indexOf(marker);
    marker_id = marker_id + 1;
    // $('#panel'+ panel_id +' panel-body:nth-child('+marker_id+')  input[name=coord_x]').val(position.lat);
    // $('#panel'+ panel_id +' panel-body:nth-child('+marker_id+')  input[name=coord_y]').val(position.lat);
    console.log(
      $('#panel-'+panel_id +' .panel-body:nth-child('+ marker_id +')  input[name="coord_x"]')
      .html());
        $('#panel-'+panel_id +' .panel-body:nth-child('+ marker_id +') input[name="coord_x"]').val(position.lat);
        $('#panel-'+panel_id +' .panel-body:nth-child('+ marker_id +') input[name="coord_y"]').val(position.lng);

  });
    e.target.addLayer(marker);
  };



// var marker = event.target;
// var position = marker.getLatLng();
// marker.setLatLng(new L.LatLng(position.lat, position.lng),{draggable:'true'});
// e.target.panTo(new L.LatLng(position.lat, position.lng));
// var marker_id = e.target.markers.indexOf(marker);
// $('#row'+ marker_id +'  td:nth-child(1)  input').val(position.lat);
// $('#row'+ marker_id +' td:nth-child(2) input').val(position.lng);

  //
  //    var planes = [
  // ["id:10",-72.625, 38.125],
  // ["id:20",-73.125, 107.75],
  // ["id:30",-81.125, 26.125],
  // ["id:40",-102.625, 109.875],
  // ["id:50",-82.125, 104.875],
  // ["id:60",-79.875, 127.125],
  // ["id:70",-71.875, 149.375],
  // ["id:80",-80.75, 160.625],
  // ["id:90",-65.875, 168.75]
  // ];
  //
  // for (var i = 0; i < planes.length; i++) {
  // marker = new L.marker([planes[i][1],planes[i][2]], {icon: new L.NumberedDivIcon({number: planes[i][0]})}).addTo(map1);
  // }


</script>
{% endblock %}
